@model StaffWeb.Models.VaccinationRecordViewModel
@{
    ViewData["Title"] = "Ghi nhận tiêm phòng";
}

<section class="card">
    <h1 class="page-title">Ghi nhận tiêm phòng</h1>
    <p class="page-subtitle">Nhập thông tin tiêm phòng cho thú cưng.</p>

    @if (TempData["Success"] != null)
    {
        <div class="alert">@TempData["Success"]</div>
    }
    @if (!ViewData.ModelState.IsValid)
    {
        <div class="alert">Kiểm tra lại thông tin bắt buộc.</div>
    }

    <form method="post">
        <div class="form-row">
            <div>
                <label>Mã thú cưng</label>
                <input asp-for="PetId" />
            </div>
            <div class="align-end">
                <label>&nbsp;</label>
                <button type="submit" name="action" value="load" class="btn btn-ghost">Tải gói đang chờ</button>
            </div>
            <div>
                <label>Chế độ tiêm</label>
                <div class="inline-options">
                    <label>
                        <input type="radio" name="Mode" value="Le" @(Model.Mode == "Goi" ? "" : "checked") />
                        Tiêm lẻ
                    </label>
                    <label>
                        <input type="radio" name="Mode" value="Goi" @(Model.Mode == "Goi" ? "checked" : "") />
                        Tiêm gói
                    </label>
                </div>
            </div>
        </div>

        <div class="form-row mode-le">
            <div>
                <label>Dịch vụ tiêm lẻ</label>
                <select asp-for="ServiceId">
                    <option value="">Chọn dịch vụ</option>
                    @foreach (var dv in Model.Services)
                    {
                        <option value="@dv.madv">@dv.madvNavigation?.tendv (@dv.madv)</option>
                    }
                </select>
            </div>
        </div>

        <div class="form-row mode-goi">
            <div class="full">
                <label>Gói đang chờ (nếu có)</label>
                <input type="hidden" name="SelectedPendingServiceId" value="@Model.SelectedPendingServiceId" />
                @if (Model.PendingPackages.Count == 0)
                {
                    <div class="muted">Thú cưng này chưa có gói nào đang chờ.</div>
                }
                else
                {
                    <div class="pending-list">
                        @foreach (var item in Model.PendingPackages)
                        {
                            <label class="pending-item">
                                <input type="radio"
                                       name="SelectedPendingStt"
                                       value="@item.Stt"
                                       data-serviceid="@item.ServiceId"
                                       @(Model.SelectedPendingStt == item.Stt ? "checked" : "") />
                                <span>
                                    @item.ServiceName (@item.ServiceId) -
                                    @item.VaccineName (@item.VaccineId) -
                                    @item.PlannedDate?.ToString("dd/MM/yyyy") -
                                    @(string.IsNullOrWhiteSpace(item.Status) ? "Chờ tiêm" : item.Status)
                                </span>
                            </label>
                        }
                    </div>
                }
            </div>
        </div>

        <div class="form-row mode-goi">
            <div>
                <label>Tạo gói mới</label>
                <select asp-for="NewPackageServiceId">
                    <option value="">Chọn gói</option>
                    @foreach (var goi in Model.PackageOptions)
                    {
                        <option value="@goi.ServiceId">
                            @goi.Name (@goi.ServiceId) - @goi.Months tháng
                        </option>
                    }
                </select>
            </div>
            <div>
                <label>Ngày bắt đầu gói</label>
                <input asp-for="PackageStartDate" type="date" />
            </div>
        </div>

        <div class="form-row">
            <div>
                <label>Vaccine</label>
                <select asp-for="VaccineId">
                    <option value="">Chọn vaccine</option>
                    @foreach (var vx in Model.Vaccines)
                    {
                        <option value="@vx.mavacxin">@vx.tenvacxin (@vx.mavacxin)</option>
                    }
                </select>
                <div class="muted">Nếu chọn gói đang chờ, vaccine sẽ dùng theo lịch đã tạo.</div>
            </div>
            <div>
                <label>Ngày tiêm</label>
                <input asp-for="Date" type="date" />
            </div>
        </div>
        <button type="submit" class="btn">Lưu</button>
    </form>
</section>

<script>
    (function () {
        const updateMode = () => {
            const mode = document.querySelector('input[name="Mode"]:checked')?.value || "Le";
            document.querySelectorAll('.mode-le').forEach(el => el.style.display = mode === "Le" ? "" : "none");
            document.querySelectorAll('.mode-goi').forEach(el => el.style.display = mode === "Goi" ? "" : "none");
        };
        const updatePendingService = () => {
            const selected = document.querySelector('input[name="SelectedPendingStt"]:checked');
            const holder = document.querySelector('input[name="SelectedPendingServiceId"]');
            if (holder) {
                holder.value = selected?.dataset?.serviceid || "";
            }
        };
        document.querySelectorAll('input[name="Mode"]').forEach(el => {
            el.addEventListener('change', updateMode);
        });
        document.querySelectorAll('input[name="SelectedPendingStt"]').forEach(el => {
            el.addEventListener('change', updatePendingService);
        });
        updateMode();
        updatePendingService();
    })();
</script>
