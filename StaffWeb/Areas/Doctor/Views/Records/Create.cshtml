@model StaffWeb.Models.DoctorRecordViewModel
@{
    ViewData["Title"] = "Tạo bệnh án";
}

<section class="card">
    <h1 class="page-title">Tạo bệnh án mới</h1>
    <p class="page-subtitle">Nhập thông tin khám và kê toa.</p>

    @if (TempData["Success"] != null)
    {
        <div class="alert">@TempData["Success"]</div>
    }
    @if (!ViewData.ModelState.IsValid)
    {
        <div class="alert">Kiểm tra lại thông tin bắt buộc.</div>
        <div asp-validation-summary="All"></div>
        <div class="alert" style="margin-top: 10px;">
            @foreach (var entry in ViewData.ModelState)
            {
                foreach (var err in entry.Value!.Errors)
                {
                    <div>@err.ErrorMessage</div>
                }
            }
        </div>
    }

    <form asp-action="Create" method="post" id="record-form">
        <input type="hidden" asp-for="IsFromAppointment" />
        <input type="hidden" asp-for="OriginalVisitTime" />
        <input type="hidden" asp-for="AppointmentTicks" />

        @if (Model.IsFromAppointment && !string.IsNullOrWhiteSpace(Model.PetName))
        {
            var birthText = Model.PetBirthDate?.ToString("dd/MM/yyyy") ?? "-";
            <div class="card" style="margin-bottom: 16px;">
                <h3>Thông tin thú cưng</h3>
                <div class="form-row">
                    <div>
                        <label>Tên thú cưng</label>
                        <input value="@Model.PetName" readonly />
                    </div>
                    <div>
                        <label>Loại</label>
                        <input value="@Model.PetType" readonly />
                    </div>
                    <div>
                        <label>Giống</label>
                        <input value="@Model.PetBreed" readonly />
                    </div>
                    <div>
                        <label>Giới tính</label>
                        <input value="@Model.PetGender" readonly />
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label>Ngày sinh</label>
                        <input value="@birthText" readonly />
                    </div>
                    <div>
                        <label>Tình trạng sức khỏe</label>
                        <input value="@Model.PetHealth" readonly />
                    </div>
                </div>
            </div>
        }

        <div class="form-row">
            <div>
                <label>Mã thú cưng</label>
                @if (Model.IsFromAppointment)
                {
                    <input value="@Model.PetId" readonly />
                    <input type="hidden" asp-for="PetId" />
                }
                else
                {
                    <input asp-for="PetId" />
                }
                <span asp-validation-for="PetId"></span>
            </div>
            <div>
                <label>Dịch vụ</label>
                @if (Model.IsFromAppointment)
                {
                    var serviceName = Model.Services.FirstOrDefault(x => x.madv == Model.ServiceId)?.tendv ?? Model.ServiceId;
                    <input value="@serviceName" readonly />
                    <input type="hidden" asp-for="ServiceId" />
                }
                else
                {
                    <select asp-for="ServiceId">
                        <option value="">Chọn dịch vụ</option>
                        @foreach (var dv in Model.Services)
                        {
                            <option value="@dv.madv">@dv.tendv</option>
                        }
                    </select>
                }
                <span asp-validation-for="ServiceId"></span>
            </div>
            <div>
                <label>Ngày giờ khám</label>
                @if (Model.IsFromAppointment)
                {
                    <input value="@(Model.VisitTime?.ToString("dd/MM/yyyy HH:mm") ?? "")" readonly />
                    <input type="hidden" name="VisitTime" value="@(Model.VisitTime?.ToString("yyyy-MM-ddTHH:mm"))" />
                }
                else
                {
                    <input asp-for="VisitTime" type="datetime-local" />
                }
                <span asp-validation-for="VisitTime"></span>
            </div>
            <div>
                <label>Ngày tái khám</label>
                <input asp-for="RecheckDate" type="date" />
                <span asp-validation-for="RecheckDate"></span>
            </div>
        </div>
        <div class="form-row">
            <div>
                <label>Triệu chứng</label>
                <textarea asp-for="Symptoms"></textarea>
            </div>
            <div>
                <label>Chẩn đoán</label>
                <textarea asp-for="Diagnosis"></textarea>
            </div>
        </div>
        <div>
            <label>Ghi chú</label>
            <textarea asp-for="Notes"></textarea>
        </div>

        <div class="card" style="margin-top: 16px;">
            <h3>Kê toa thuốc (tùy chọn)</h3>
            <div class="form-row">
                <div>
                    <label>Tên toa</label>
                    <input asp-for="PrescriptionName" placeholder="Toa thuốc ABC" />
                </div>
            </div>
            <div id="exam-medicine-rows">
                @for (var i = 0; i < Model.Items.Count; i++)
                {
                    var selectedId = Model.Items[i].MedicineId;
                    <div class="form-row medicine-row">
                        <div>
                            <label>Thuốc</label>
                            <select name="Items[@i].MedicineId">
                                <option value="">Chọn thuốc</option>
                                @foreach (var sp in Model.Medicines)
                                {
                                    if (sp.masp == selectedId)
                                    {
                                        <option value="@sp.masp" selected>@sp.tensp</option>
                                    }
                                    else
                                    {
                                        <option value="@sp.masp">@sp.tensp</option>
                                    }
                                }
                            </select>
                        </div>
                        <div>
                            <label>Số lượng</label>
                            <input name="Items[@i].Quantity" type="number" min="1" value="@(Model.Items[i].Quantity?.ToString() ?? "")" />
                        </div>
                        <div>
                            <label>Liều lượng</label>
                            <input name="Items[@i].Dosage" placeholder="2 lần/ngày" value="@(Model.Items[i].Dosage ?? "")" />
                        </div>
                        <div>
                            <label>Ghi chú</label>
                            <input name="Items[@i].Note" placeholder="Uống sau ăn" value="@(Model.Items[i].Note ?? "")" />
                        </div>
                        <div style="align-self:end;">
                            <button type="button" class="btn btn-secondary remove-row">Xóa</button>
                        </div>
                    </div>
                }
            </div>
            <button type="button" class="btn btn-secondary" id="add-exam-medicine">Thêm thuốc</button>
        </div>

        <div style="margin-top: 16px;">
            <button type="submit" class="btn">Lưu bệnh án</button>
        </div>
    </form>
</section>

<template id="exam-medicine-template">
    <div class="form-row medicine-row">
        <div>
            <label>Thuốc</label>
            <select name="Items[__index__].MedicineId">
                <option value="">Chọn thuốc</option>
                @foreach (var sp in Model.Medicines)
                {
                    <option value="@sp.masp">@sp.tensp</option>
                }
            </select>
        </div>
        <div>
            <label>Số lượng</label>
            <input name="Items[__index__].Quantity" type="number" min="1" />
        </div>
        <div>
            <label>Liều lượng</label>
            <input name="Items[__index__].Dosage" placeholder="2 lần/ngày" />
        </div>
        <div>
            <label>Ghi chú</label>
            <input name="Items[__index__].Note" placeholder="Uống sau ăn" />
        </div>
        <div style="align-self:end;">
            <button type="button" class="btn btn-secondary remove-row">Xóa</button>
        </div>
    </div>
</template>

<script>
    (function () {
        var rows = document.getElementById("exam-medicine-rows");
        var addBtn = document.getElementById("add-exam-medicine");
        var template = document.getElementById("exam-medicine-template");
        var form = document.getElementById("record-form");

        function nextIndex() {
            return rows.querySelectorAll(".medicine-row").length;
        }

        function bindRemove(container) {
            var btns = container.querySelectorAll(".remove-row");
            btns.forEach(function (btn) {
                btn.addEventListener("click", function () {
                    var row = btn.closest(".medicine-row");
                    if (row) {
                        row.remove();
                    }
                });
            });
        }

        bindRemove(rows);

        addBtn.addEventListener("click", function () {
            var html = template.innerHTML.replaceAll("__index__", nextIndex());
            var wrapper = document.createElement("div");
            wrapper.innerHTML = html;
            var row = wrapper.firstElementChild;
            rows.appendChild(row);
            bindRemove(row);
        });

        form.addEventListener("submit", function () {
            var rowList = rows.querySelectorAll(".medicine-row");
            rowList.forEach(function (row, idx) {
                row.querySelectorAll("select, input").forEach(function (el) {
                    var name = el.getAttribute("name");
                    if (!name) return;
                    el.setAttribute("name", name.replace(/Items\\[\\d+\\]/, "Items[" + idx + "]"));
                });
            });
        });
    })();
</script>
