@model StaffWeb.Models.DirectorRevenueViewModel
@{
    ViewData["Title"] = "Doanh thu hệ thống";
    var totalSources = Model.Sources.Sum(x => x.Value);
    var colors = new[] { "#2d7f7e", "#b07a34", "#4d6b3a" };
    var segments = new List<string>();
    decimal angle = 0;
    for (var i = 0; i < Model.Sources.Count; i++)
    {
        var slice = Model.Sources[i];
        var percent = totalSources <= 0 ? 0 : slice.Value / totalSources;
        var start = angle;
        var end = angle + (percent * 360);
        segments.Add($"{colors[i % colors.Length]} {start:F2}deg {end:F2}deg");
        angle = end;
    }
    var pieStyle = segments.Count == 0 ? "background: #f0f0f0;" : $"background: conic-gradient({string.Join(", ", segments)});";
    var periodLabel = Model.Period switch
    {
        "week" => "Tuần",
        "month" => "Tháng",
        "year" => "Năm",
        _ => "Ngày"
    };
}

<style>
    .chart-tooltip {
        position: fixed;
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 13px;
        pointer-events: none;
        z-index: 1000;
        display: none;
        white-space: nowrap;
    }
    .manager-bar:hover {
        transform: scale(1.05);
        transition: transform 0.2s ease;
    }
    .director-pie-row {
        cursor: pointer;
        transition: transform 0.2s ease;
    }
    .director-pie-row:hover {
        transform: scale(1.05);
    }
    .table tbody tr {
        transition: transform 0.2s ease;
        cursor: pointer;
    }
    .table tbody tr:hover {
        transform: scale(1.01);
        background-color: #f8f9fa;
    }
</style>

<div class="chart-tooltip" id="chartTooltip"></div>

<section class="card">
    <h1 class="page-title">Báo cáo doanh thu</h1>
    <p class="page-subtitle">Thống kê doanh thu theo chi nhánh và nguồn thu.</p>

    <form method="get">
        <div class="form-row">
            <div>
                <label>Từ ngày</label>
                <input type="date" name="fromDate" value="@(Model.FromDate?.ToString("yyyy-MM-dd"))" />
            </div>
            <div>
                <label>Đến ngày</label>
                <input type="date" name="toDate" value="@(Model.ToDate?.ToString("yyyy-MM-dd"))" />
            </div>
            <div>
                <label>Chi nhánh</label>
                <select name="branchId">
                    <option value="">Tất cả chi nhánh</option>
                    @foreach (var branch in Model.Branches)
                    {
                        if (branch.Id == Model.BranchId)
                        {
                            <option value="@branch.Id" selected>@branch.Name</option>
                        }
                        else
                        {
                            <option value="@branch.Id">@branch.Name</option>
                        }
                    }
                </select>
            </div>
            <div>
                <label>Chu kỳ</label>
                <select name="period">
                    @if (Model.Period == "day")
                    {
                        <option value="day" selected>Ngày</option>
                    }
                    else
                    {
                        <option value="day">Ngày</option>
                    }
                    @if (Model.Period == "week")
                    {
                        <option value="week" selected>Tuần</option>
                    }
                    else
                    {
                        <option value="week">Tuần</option>
                    }
                    @if (Model.Period == "month")
                    {
                        <option value="month" selected>Tháng</option>
                    }
                    else
                    {
                        <option value="month">Tháng</option>
                    }
                    @if (Model.Period == "year")
                    {
                        <option value="year" selected>Năm</option>
                    }
                    else
                    {
                        <option value="year">Năm</option>
                    }
                </select>
            </div>
        </div>
        <button type="submit" class="btn">Xem báo cáo</button>
    </form>
</section>

@if (Model.BranchRevenue.HasValue)
{
    <section class="card" style="margin-top: 20px;">
        <h3>Doanh thu chi nhánh</h3>
        <p><strong>Chi nhánh:</strong> @(Model.BranchName ?? Model.BranchId)</p>
        <p><strong>Tổng doanh thu:</strong> @Model.BranchRevenue.Value.ToString("N0")</p>
    </section>
}

@if (Model.Sources.Count > 0)
{
    <section class="card" style="margin-top: 20px;">
        <h3>Cơ cấu doanh thu</h3>
        <div class="director-pie-wrap">
            <div class="director-pie" style="@pieStyle"></div>
            <div class="director-pie-legend">
                @for (var i = 0; i < Model.Sources.Count; i++)
                {
                    var slice = Model.Sources[i];
                    var percent = totalSources <= 0 ? 0 : (slice.Value / totalSources) * 100;
                    <div class="director-pie-row" data-value="@slice.Value.ToString("N0")" data-label="@slice.Name (@percent.ToString("F1")%)">
                        <span class="director-pie-dot" style="background:@colors[i % colors.Length];"></span>
                        <span>@slice.Name</span>
                        <span>@slice.Value.ToString("N0")</span>
                    </div>
                }
            </div>
        </div>
    </section>
}

@if (Model.Trend.Count > 0)
{
    var max = Model.Trend.Max(x => x.tongdoanhthu);
    <section class="card" style="margin-top: 20px;">
        <h3>Doanh thu theo @periodLabel</h3>
        <div class="manager-chart">
            @foreach (var item in Model.Trend)
            {
            var height = max == 0 ? 0 : (int)Math.Round(item.tongdoanhthu / max * 100);
            if (height > 0 && height < 15)
            {
                height = 15;
            }
                var label = Model.Period switch
                {
                    "week" => $"Tuần {item.ngay:dd/MM}",
                    "month" => item.ngay.ToString("MM/yyyy"),
                    "year" => item.ngay.ToString("yyyy"),
                    _ => item.ngay.ToString("dd/MM")
                };
                <div class="manager-bar" data-value="@item.tongdoanhthu.ToString("N0")" data-label="@label">
                    <div class="manager-bar-track">
                        <div class="manager-bar-fill" style="height:@height%"></div>
                    </div>
                    <span>@label</span>
                </div>
            }
        </div>
    </section>
}

@if (Model.Items.Count > 0 && string.IsNullOrWhiteSpace(Model.BranchId))
{
    <section class="card" style="margin-top: 20px;">
        <h3>Doanh thu theo chi nhánh</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Mã CN</th>
                    <th>Tên chi nhánh</th>
                    <th>Số hóa đơn</th>
                    <th>Tổng doanh thu</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var row in Model.Items)
                {
                    <tr data-value="@row.tongdoanhthu.ToString("N0")" data-label="@row.tencn">
                        <td>@row.macn</td>
                        <td>@row.tencn</td>
                        <td>@row.sohoadon</td>
                        <td>@row.tongdoanhthu.ToString("N0")</td>
                    </tr>
                }
            </tbody>
        </table>
    </section>
}

@if (Model.FromDate.HasValue && Model.ToDate.HasValue && Model.Items.Count == 0 && Model.Sources.Count == 0)
{
    <div class="alert" style="margin-top: 16px;">Không có dữ liệu trong khoảng ngày này.</div>
}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tooltip = document.getElementById('chartTooltip');
        const elements = document.querySelectorAll('[data-value][data-label]');
        
        elements.forEach(el => {
            el.addEventListener('mouseenter', function(e) {
                const value = this.getAttribute('data-value');
                const label = this.getAttribute('data-label');
                tooltip.textContent = label + ': ' + value;
                tooltip.style.display = 'block';
            });
            
            el.addEventListener('mousemove', function(e) {
                tooltip.style.left = (e.clientX + 15) + 'px';
                tooltip.style.top = (e.clientY + 15) + 'px';
            });
            
            el.addEventListener('mouseleave', function() {
                tooltip.style.display = 'none';
            });
        });
    });
</script>
